# auto-fix-scheduler

JIRA í‹°ì¼“ì˜ `ai:auto-fix` ë¼ë²¨ì„ ê°ì§€í•˜ì—¬ ìë™ìœ¼ë¡œ ì½”ë“œ ìˆ˜ì •ì„ ìˆ˜í–‰í•˜ëŠ” ìŠ¤ì¼€ì¤„ ê¸°ë°˜ ì›Œí¬í”Œë¡œìš°.

---

## ê°œìš”

| í•­ëª© | ê°’ |
|------|-----|
| **íŠ¸ë¦¬ê±°** | Schedule (10ë¶„ ê°„ê²©) |
| **ì£¼ìš” ê¸°ëŠ¥** | JIRA í‹°ì¼“ ìë™ ìˆ˜ì •, MR ìƒì„±, ë¦¬ë·°ì–´ í• ë‹¹, ìƒíƒœ ì „ì´ |

---

## n8n Workflow

![auto-fix-scheduler](../../assets/auto-fix-scheduler.png)

---

## JIRA ìƒíƒœ ì „ì´

### ì„±ê³µ ì¼€ì´ìŠ¤

```
Backlog â”€â”€â–º To Do â”€â”€â–º In Progress â”€â”€â–º Resolved
   â”‚                                      â”‚
   â””â”€â”€ ai:auto-fix â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º ai:auto-fixed
```

### ì‹¤íŒ¨ ì¼€ì´ìŠ¤

```
Backlog â”€â”€â–º To Do â”€â”€â–º In Progress â”€â”€â–º Backlog
   â”‚                                      â”‚
   â””â”€â”€ ai:auto-fix â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º ai:auto-fix-failed
```

---

## ë…¸ë“œ ìƒì„¸

### 1. Fetch Tickets

JIRA APIë¡œ `ai:auto-fix` ë¼ë²¨ì´ ìˆëŠ” í‹°ì¼“ ì¡°íšŒ:

```
JQL: project = __JIRA_PROJECT__ AND labels = "ai:auto-fix" AND status = BACKLOG ORDER BY created ASC
LIMIT: 5
```

**ì‚¬ìš© ë…¸ë“œ**: `n8n-nodes-base.jira` (Native JIRA Node)

### 2. Check Status

ìƒíƒœ í™•ì¸ ë° ë‚ ì§œ ê³„ì‚°:

```javascript
const issue = $input.item.json;
const status = issue.fields?.status?.name || '';
const needsToDoTransition = status === 'Backlog';
const today = new Date().toISOString().split('T')[0];
const nextWeek = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

return {
  json: {
    ...issue,
    needsToDoTransition,
    startDate: today,
    dueDate: nextWeek
  }
};
```

### 3. Set Dates (Backlogì¸ ê²½ìš°)

JIRA í‹°ì¼“ì— ì‹œì‘ì¼/ë§ˆê°ì¼ ì„¤ì •:

**ì‚¬ìš© ë…¸ë“œ**: `n8n-nodes-base.jira` (Native JIRA Node)

```json
{
  "operation": "update",
  "issueKey": "{{ $json.key }}",
  "updateFields": {
    "customfield_10015": "{{ $json.startDate }}",
    "duedate": "{{ $json.dueDate }}"
  }
}
```

### 4. Status Transitions

JIRA ìƒíƒœ ì „ì´ (Native JIRA Node ì‚¬ìš©):

| ë…¸ë“œ | Status ID | ì„¤ëª… |
|------|-----------|------|
| To Do | 51 | Backlog â†’ To Do |
| In Progress | 21 | To Do â†’ In Progress |
| Resolved | 31 | In Progress â†’ Resolved (ì„±ê³µ ì‹œ) |
| Back to Backlog | 61 | In Progress â†’ Backlog (ì‹¤íŒ¨ ì‹œ) |

### 5. Build Prompt

Auto Fixer ì—ì´ì „íŠ¸ìš© í”„ë¡¬í”„íŠ¸ êµ¬ì„±:

```javascript
const issue = $('Check Status').item.json;
const prompt = `Auto-fix JIRA ticket

**JIRA Key**: ${issue.key}
**Summary**: ${issue.fields?.summary || 'N/A'}`;

return {
  json: {
    jira_key: issue.key,
    jira_summary: issue.fields?.summary,
    prompt
  }
};
```

### 6. Auto Fix

Claude Code ì‹¤í–‰:

```
POST {N8N_API_URL}/v1/projects/system/chat
```

```json
{
  "user_message": "<Build Prompt ê²°ê³¼>",
  "agent": "Auto Fixer",
  "source": "scheduler",
  "requester": "auto-fix-scheduler",
  "metadata": {
    "jira_key": "<jira_key>",
    "workflow_execution_id": "<n8n execution id>"
  }
}
```

**Timeout**: 600ì´ˆ (10ë¶„)

### 7. Parse Result

Structured Output íŒŒì‹± ë° ë¦¬ë·°ì–´ ì„¤ì •:

```javascript
const prev = $('Build Prompt').item.json;
const r = $input.item.json;
let res = {
  fixed: false,
  branch_name: '',
  commit_sha: '',
  files_changed: [],
  summary: '',
  error: ''
};

if (r.status !== 'completed') {
  res.error = r.error?.message || 'API error';
} else if (r.structured_output) {
  res = { ...res, ...r.structured_output };
} else {
  res.error = 'No structured output';
}

// .n8n-config.jsonì˜ autoFixReviewersì—ì„œ ì£¼ì…ë¨ (ì½¤ë§ˆ êµ¬ë¶„ ë¬¸ìì—´ â†’ ë°°ì—´ ë³€í™˜)
const reviewers = '__AUTO_FIX_REVIEWERS__'.split(',').filter(Boolean);

return { json: { ...prev, ...res, execution_id: r.id, reviewers } };
```

### 8. Create MR

GitLab MR ìƒì„± (ë¦¬ë·°ì–´ usernameìœ¼ë¡œ ì§ì ‘ í• ë‹¹):

```
POST https://__GITLAB_HOST__/api/v4/projects/__GITLAB_PROJECT__/merge_requests
```

```json
{
  "source_branch": "{{ branch_name }}",
  "target_branch": "__TARGET_BRANCH__",
  "title": "[{{ jira_key }}] {{ jira_summary }}",
  "description": "## Auto-fix\n\n{{ summary }}\n\n**Files changed:**\n{{ files_changed }}\n\n---\nğŸ¤– Generated by Auto Fixer",
  "remove_source_branch": true,
  "reviewers": ["username1", "username2"]
}
```

### 9. Parse MR

MR ì‘ë‹µ íŒŒì‹±:

```javascript
const prev = $('Fixed?').item.json;
const mr = $input.item.json;
const mr_url = mr.web_url || null;
const mr_iid = mr.iid || null;
return { json: { ...prev, mr_url, mr_iid } };
```

### 10. Label Update

**ì„±ê³µ ì‹œ** (Native JIRA Node):
```json
{
  "operation": "update",
  "issueKey": "{{ jira_key }}",
  "updateFields": {
    "labels": ["ai:auto-fixed"]
  }
}
```

**ì‹¤íŒ¨ ì‹œ** (Native JIRA Node):
```json
{
  "operation": "update",
  "issueKey": "{{ jira_key }}",
  "updateFields": {
    "labels": ["ai:auto-fix-failed"]
  }
}
```

### 11. JIRA Comment

**ì„±ê³µ ì‹œ** (Native JIRA Node):
```
ğŸ¤– *Auto-fix completed*

â€¢ Branch: {{ branch_name }}
â€¢ MR: {{ mr_url }}
â€¢ Commit: {{ commit_sha }}

{{ summary }}
```

**ì‹¤íŒ¨ ì‹œ** (Native JIRA Node):
```
ğŸ¤– *Auto-fix failed*

{{ error || summary || 'Unknown error' }}
```

---

## Auto Fixer Agent

### Structured Output Schema

```json
{
  "type": "object",
  "properties": {
    "fixed": {
      "type": "boolean",
      "description": "ìˆ˜ì • ì„±ê³µ ì—¬ë¶€"
    },
    "branch_name": {
      "type": "string",
      "description": "ìƒì„±ëœ ë¸Œëœì¹˜ ì´ë¦„"
    },
    "commit_sha": {
      "type": "string",
      "description": "ì»¤ë°‹ SHA"
    },
    "files_changed": {
      "type": "array",
      "items": { "type": "string" },
      "description": "ë³€ê²½ëœ íŒŒì¼ ëª©ë¡"
    },
    "summary": {
      "type": "string",
      "description": "ìˆ˜ì • ë‚´ìš© ìš”ì•½"
    }
  },
  "required": ["fixed"]
}
```

---

## JIRA ë¼ë²¨

| ë¼ë²¨ | ì˜ë¯¸ |
|------|------|
| `ai:auto-fix` | ìë™ ìˆ˜ì • ëŒ€ìƒ (ì…ë ¥) |
| `ai:auto-fixed` | ìë™ ìˆ˜ì • ì™„ë£Œ |
| `ai:auto-fix-failed` | ìë™ ìˆ˜ì • ì‹¤íŒ¨ |

---

## ì„¤ì •

### Placeholder

| Placeholder | ì„¤ëª… | Config Key |
|-------------|------|------------|
| `__JIRA_PROJECT__` | JIRA í”„ë¡œì íŠ¸ í‚¤ | `jira.project` |
| `__GITLAB_HOST__` | GitLab í˜¸ìŠ¤íŠ¸ | `gitlab.host` |
| `__GITLAB_PROJECT__` | GitLab í”„ë¡œì íŠ¸ ê²½ë¡œ (URL ì¸ì½”ë”©) | `gitlab.project` |
| `__AUTO_FIX_REVIEWERS__` | MR ë¦¬ë·°ì–´ username (ì½¤ë§ˆ êµ¬ë¶„) | `autoFixReviewers` |
| `__JIRA_CREDENTIAL_ID__` | JIRA API ì¸ì¦ ID | `credentials.jiraSoftwareCloudApi.id` |
| `__GITLAB_CREDENTIAL_ID__` | GitLab API ì¸ì¦ ID | `credentials.httpHeaderAuth.id` |

### n8n í™˜ê²½ë³€ìˆ˜

| ë³€ìˆ˜ | ì„¤ëª… |
|------|------|
| `N8N_API_URL` | claudio-api URL |

### Credentials

| Credential | ìš©ë„ |
|------------|------|
| `jiraSoftwareCloudApi` | JIRA API ì¸ì¦ |
| `httpHeaderAuth` | GitLab API ì¸ì¦ |

---

## ë¦¬ë·°ì–´ í• ë‹¹

`.n8n-config.json`ì˜ `autoFixReviewers`ì—ì„œ ì½¤ë§ˆë¡œ êµ¬ë¶„ëœ ë¦¬ë·°ì–´ ëª©ë¡ì„ ì„¤ì •í•©ë‹ˆë‹¤.

```json
{
  "autoFixReviewers": "username1,username2,username3"
}
```

`n8n-workflows.sh push` ì‹¤í–‰ ì‹œ `__AUTO_FIX_REVIEWERS__` í”Œë ˆì´ìŠ¤í™€ë”ê°€ í•´ë‹¹ ë¬¸ìì—´ë¡œ ì¹˜í™˜ë˜ê³ , `Parse Result` ë…¸ë“œì—ì„œ `.split(',').filter(Boolean)`ìœ¼ë¡œ ë°°ì—´ë¡œ ë³€í™˜ë©ë‹ˆë‹¤.

GitLab APIì˜ `reviewers` íŒŒë¼ë¯¸í„°ì— username ë°°ì—´ì„ ì „ë‹¬í•˜ë©´ ìë™ìœ¼ë¡œ í•´ë‹¹ ì‚¬ìš©ìê°€ ë¦¬ë·°ì–´ë¡œ í• ë‹¹ë©ë‹ˆë‹¤.

---

## ì—ëŸ¬ ì²˜ë¦¬

### API íƒ€ì„ì•„ì›ƒ

```javascript
if (r.status === 'timeout') {
  // ë¼ë²¨: ai:auto-fix-failed
  // JIRA ì½”ë©˜íŠ¸: íƒ€ì„ì•„ì›ƒ ì•Œë¦¼
  // ìƒíƒœ: Backlogë¡œ ë³µê·€
}
```

### Structured Output ì—†ìŒ

```javascript
if (!r.structured_output) {
  // ì—ëŸ¬ ì²˜ë¦¬: "No structured output"
  // ì‹¤íŒ¨ í”Œë¡œìš°ë¡œ ë¶„ê¸°
}
```

### MR ìƒì„± ì‹¤íŒ¨

ëª¨ë“  JIRA/GitLab API í˜¸ì¶œì— `onError: continueRegularOutput` ì„¤ì •ìœ¼ë¡œ ì›Œí¬í”Œë¡œìš° ì¤‘ë‹¨ ë°©ì§€.

---

## ì—°ê´€ ì›Œí¬í”Œë¡œìš°

- [slack-message-handler](slack-message-handler.md) â€” `can_auto_fix` í”Œë˜ê·¸ë¡œ ìë™ ìˆ˜ì • ê°€ëŠ¥ ì—¬ë¶€ í‘œì‹œ
- [slack-reaction-handler](slack-reaction-handler.md) â€” `:two:` ë¦¬ì•¡ì…˜ìœ¼ë¡œ `ai:auto-fix` ë¼ë²¨ ì¶”ê°€
